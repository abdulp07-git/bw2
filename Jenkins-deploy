pipeline {
    agent any 

    environment {
        
        AZURE_SECRET = credentials('azure_principal_secret')
        AZURE_SUBSCRIPTION = credentials('azure_subscribtion')
        AZURE_TENANT = credentials('azure_tenant')
        AZURE_USER = credentials('azure_user')
        SSH_PRIVATE_KEY = credentials('my_ssh_key')
        REMOTE_USER = "azureuser"
        REMOTE_HOST = "20.204.132.111"
       
    }


    stages {
        stage ("Deployment using gateway server"){
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'my_ssh_key', keyFileVariable: 'SSH_KEY')]){
                    sh """
                    ssh -i $SSH_KEY -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST << EOF
                        echo "Running commands on remote VM"
                    az login --service-principal -u $AZURE_USER -p $AZURE_SECRET --tenant $AZURE_TENANT
                    
                    az aks get-credentials --resource-group bw89rg --name bwaks --overwrite-existing
                    kubectl apply -f aks-files/maven-app/maven.yml -n staging


                    EOF
                    """
                }
            }
        }
    }
}
